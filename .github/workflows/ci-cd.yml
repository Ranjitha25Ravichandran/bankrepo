name: Java CI/CD bank project

on:
   push:
      branches: main
   pull_request:
      branches: main

jobs:
   build:

      runs-on: ubuntu-latest

      steps:
      -  name: Checkout source code
         uses: actions/checkout@v4
      -  name: Set up JDK 17
         uses: actions/setup-java@v4
         with:
            java-version: '17'
            distribution: temurin
            cache: maven
      -  name: Start Docker Compose
         run: docker compose up -d

      -  name: Wait for MySQL
         run: |
            until docker exec mysql-bank mysqladmin ping -uroot -proot; do
              sleep 5
            done

      -  name: Build and analyze
         run: mvn clean verify sonar:sonar -Dsonar.token=${{ secrets.SONAR_TOKEN }}