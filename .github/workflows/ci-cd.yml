name: Java CI/CD bank project

on:
   push:
      branches: main
   pull_request:
      branches: main

jobs:
   build:

      runs-on: ubuntu-latest

      env:
        SPRING_DATASOURCE_USERNAME: root
        SPRING_DATASOURCE_PASSWORD: root
        
      services:
        mysql:
          image: mysql:8.0
          env:
            MYSQL_ROOT_PASSWORD: root
            MYSQL_DATABASE: rrbank
          ports:
            - 3306:3306
          options: >-
            --health-cmd="mysqladmin ping --silent"
            --health-interval=10s
            --health-timeout=5s
            --health-retries=5


      steps:
      -  name: Checkout source code
         uses: actions/checkout@v4
      -  name: Set up JDK 17
         uses: actions/setup-java@v4
         with:
            java-version: '17'
            distribution: temurin
            cache: maven

      -  name: Wait for MySQL
         run: |
          echo "Waiting for MySQL..."
          until mysqladmin ping -h127.0.0.1 -uroot -proot; do
            sleep 5
          done

      -  name: Build and analyze
         run: mvn clean verify sonar:sonar -Dsonar.token=${{ secrets.SONAR_TOKEN }}